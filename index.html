<script>
  let mediaRecorder;
  let audioChunks = [];
  let audioBlob;
  let isPaused = false;

  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const submitBtn = document.getElementById('submitBtn');
  const previewContainer = document.getElementById('previewContainer');
  const status = document.getElementById('status');

  const urlParams = new URLSearchParams(window.location.search);
  const name = urlParams.get('name') || "unknown";
  const email = urlParams.get('email') || "noemail";
  const week = urlParams.get('week');
  const questionId = urlParams.get('questionId');

  let filename = "";
  if (questionId) {
    filename = `LIV_${name}_${email}_${questionId}.wav`;
  } else if (week) {
    filename = `LIV_${name}_${email}_Week${week}.wav`;
  } else {
    filename = `LIV_${name}_${email}.wav`;
  }

  startBtn.onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) {
        audioChunks.push(e.data);
      }
    };

    mediaRecorder.onstop = () => {
      audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.src = audioUrl;

      previewContainer.innerHTML = '';
      previewContainer.appendChild(audio);
      deleteBtn.disabled = false;
      submitBtn.disabled = false;
      pauseBtn.disabled = true;
      status.textContent = `üéß Ready to review.`;
    };

    mediaRecorder.start();
    isPaused = false;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    pauseBtn.disabled = false;
    pauseBtn.textContent = 'Pause';
    status.textContent = `üéôÔ∏è Recording...`;
  };

  pauseBtn.onclick = () => {
    if (!mediaRecorder) return;

    if (!isPaused) {
      mediaRecorder.pause();
      isPaused = true;
      pauseBtn.textContent = 'Resume';
      status.textContent = '‚è∏Ô∏è Recording paused.';
    } else {
      mediaRecorder.resume();
      isPaused = false;
      pauseBtn.textContent = 'Pause';
      status.textContent = 'üéôÔ∏è Recording resumed...';
    }
  };

  stopBtn.onclick = () => {
    mediaRecorder.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
    pauseBtn.disabled = true;
    pauseBtn.textContent = 'Pause';
  };

  deleteBtn.onclick = () => {
    audioChunks = [];
    audioBlob = null;
    previewContainer.innerHTML = '';
    deleteBtn.disabled = true;
    submitBtn.disabled = true;
    status.textContent = 'üóëÔ∏è Recording deleted. Start again when ready.';
  };

  submitBtn.onclick = async () => {
    if (!audioBlob) return;

    const formData = new FormData();
    formData.append('file', audioBlob, filename);

    try {
      const response = await fetch('https://hook.eu2.make.com/nsbtpvkksxfjkifpe2our0hxn5ykf6ip', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        status.innerHTML = `‚úÖ Recording submitted successfully`;
        submitBtn.disabled = true;
        deleteBtn.disabled = true;
      } else {
        status.textContent = '‚ùå Failed to submit recording.';
      }
    } catch (error) {
      status.textContent = '‚ùå Upload error: ' + error.message;
    }
  };
</script>
