<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Record Your Story — Safe Recorder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{ --bg:#ffffff; --fg:#222; --muted:#666; --ok:#2E7D32; --warn:#C0392B; --btn:#ccc; --brand:#1B4D3E; }
    body { font-family: Georgia, serif; text-align:center; margin:40px auto; padding:0 20px; max-width:760px; background:var(--bg); color:var(--fg); }
    h1 { margin-bottom:6px; }
    p.lead { margin-top:0; color:var(--muted); }
    button{ box-sizing:border-box; display:block; width:100%; max-width:420px; font-size:20px; padding:16px 24px; margin:10px auto; border-radius:10px; border:none; background:var(--btn); cursor:pointer; box-shadow:0 2px 0 rgba(0,0,0,.08);}
    button[disabled]{ opacity:.55; cursor:not-allowed }
    audio { margin:8px auto; display:block; width:100%; max-width:520px; }
    .status { font-size:16px; margin-top:14px; min-height:22px; }
    #logo { margin-top:26px; width:150px; }
    #questionWrapper{ margin:20px auto; }
    #questionWrapper h3{ margin:0 0 6px; color:var(--brand); }
    #questionDisplay{ font-style:italic; font-size:18px; color:var(--fg); word-break:break-word; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; font-size:14px; }
    .pill.ok { background:#E8F5E9; color:var(--ok); }
    .pill.warn { background:#FDECEA; color:var(--warn); }
    .bar-wrap{ margin:8px auto 0; width:240px; height:10px; background:#eee; border-radius:999px; overflow:hidden; }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg,#8BC34A,#FFC107); transition:width .18s linear; }
    .tips { font-size:14px; color:var(--muted); margin-top:10px; }
    .take { text-align:left; margin:10px 0; padding:10px; border:1px solid #eee; border-radius:10px; }
    .take header { display:flex; align-items:center; gap:10px; margin-bottom:6px; }
    .take header label { display:flex; align-items:center; gap:8px; cursor:pointer; }
    .take .meta { font-size:13px; color:#666; }
    .badge { font-size:12px; padding:2px 8px; border-radius:999px; background:#eef; margin-left:8px; }
    @media (max-width:900px){ button{ max-width:520px; } }
    .filters { display:flex; align-items:center; justify-content:center; gap:10px; margin:14px 0 6px; font-size:14px; color:#444; }
  </style>
</head>
<body>
  <h1>Record Your Story</h1>
  <p class="lead">Press “Start Recording” to begin. Click “Stop” to save a take. You can record multiple takes and select one or more to submit. Your takes are auto-saved and survive refreshes or crashes.</p>

  <!-- Question -->
  <div id="questionWrapper">
    <h3>Question:</h3>
    <div id="questionDisplay"></div>
  </div>

  <!-- Mic -->
  <div id="micRow" aria-live="polite" style="margin:10px 0 18px;">
    <span id="micPill" class="pill warn">Mic not active</span>
    <div class="bar-wrap"><div id="levelBar" class="bar"></div></div>
    <div class="tips">If the bar doesn't move when you talk, check browser mic permissions and device settings.</div>
  </div>

  <!-- Controls -->
  <button id="startBtn">Start Recording</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="stopBtn" disabled>Stop Recording</button>
  <button id="deleteBtn" disabled>Delete Selected Take(s)</button>
  <button id="submitBtn" disabled>Submit Selected Take(s)</button>

  <div class="filters">
    <label><input type="checkbox" id="showSubmitted"> Show submitted takes</label>
  </div>

  <div id="takesContainer"></div>
  <div id="status" class="status" role="status" aria-live="polite"></div>
  <img id="logo" src="logo.png" alt="Life In Voices Logo" />

  <script>
    // --- URL params ---
    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('name') || "unknown";
    const email = urlParams.get('email') || "noemail";
    const week = urlParams.get('week');
    const questionId = urlParams.get('questionId');
    const rawText = urlParams.get('questionText') ?? urlParams.get('question') ?? urlParams.get('q');

    // Base filename + idempotency key
    const base = questionId ? `LIV_${name}_${email}_${questionId}` : week ? `LIV_${name}_${email}_Week${week}` : `LIV_${name}_${email}`;
    const IDEMPOTENCY_KEY = base;
    const GROUP_KEY = questionId ? `QID:${name}|${email}|${questionId}` : week ? `WEEK:${name}|${email}|${week}` : `GEN:${name}|${email}`;

    // Show Question
    (function showQuestion(){
      const el = document.getElementById('questionDisplay');
      if (!rawText){ document.getElementById('questionWrapper').style.display="none"; return; }
      let decoded = rawText;
      try { decoded = decodeURIComponent(rawText.replace(/\+/g,' ')); } catch {}
      el.textContent = `“${decoded}”`;
      ['questionText','question','q'].forEach(k => urlParams.delete(k));
      const q = urlParams.toString();
      window.history.replaceState({}, document.title, window.location.pathname + (q? '?'+q : ''));
    })();

    // === IndexedDB (with groupKey) ===
    const DB_NAME='liv-recorder', DB_STORE='takes'; let db=null;
    function openDB(){ return new Promise((res,rej)=>{ const req=indexedDB.open(DB_NAME,3); req.onupgradeneeded=e=>{const d=e.target.result; if(!d.objectStoreNames.contains(DB_STORE)){const s=d.createObjectStore(DB_STORE,{keyPath:'id',autoIncrement:true}); s.createIndex('groupKey','groupKey',{unique:false});} else {const s=e.target.transaction.objectStore(DB_STORE); if(!s.indexNames.contains('groupKey')) s.createIndex('groupKey','groupKey',{unique:false});}}; req.onsuccess=()=>{db=req.result; res(db)}; req.onerror=()=>rej(req.error)});}
    const idbAdd=r=>new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readwrite');const st=tx.objectStore(DB_STORE);const q=st.add(r);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});
    const idbAll=()=>new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readonly');const st=tx.objectStore(DB_STORE);const q=st.getAll();q.onsuccess=()=>res(q.result||[]);q.onerror=()=>rej(q.error);});
    const idbPut=r=>new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readwrite');const st=tx.objectStore(DB_STORE);const q=st.put(r);q.onsuccess=()=>res();q.onerror=()=>rej(q.error);});
    const idbDel=id=>new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readwrite');const st=tx.objectStore(DB_STORE);const q=st.delete(id);q.onsuccess=()=>res();q.onerror=()=>rej(q.error);});

    let takes=[];
    const els={ startBtn:document.getElementById('startBtn'),stopBtn:document.getElementById('stopBtn'),pauseBtn:document.getElementById('pauseBtn'),deleteBtn:document.getElementById('deleteBtn'),submitBtn:document.getElementById('submitBtn'),takes:document.getElementById('takesContainer'),status:document.getElementById('status'),micPill:document.getElementById('micPill'),levelBar:document.getElementById('levelBar'),showSubmitted:document.getElementById('showSubmitted') };

    async function hydrate(){ try{ await openDB(); const all=await idbAll(); takes=all.map(r=>({...r,url:URL.createObjectURL(r.blob)})); render(); }catch(e){console.warn('DB load fail',e)}}
    function render(){ els.takes.innerHTML=''; const showSub=els.showSubmitted.checked; takes.forEach((t,i)=>{ if(t.groupKey!==GROUP_KEY) return; if(!showSub&&t.submitted) return; const row=document.createElement('div');row.className='take'; const lab=document.createElement('label'); const cb=document.createElement('input'); cb.type='checkbox'; cb.value=i; lab.appendChild(cb); const title=document.createElement('strong'); title.textContent=t.label; lab.appendChild(title); const meta=document.createElement('span'); meta.className='meta'; meta.textContent=` — ${(t.durMs/1000).toFixed(1)}s, ${(t.size/1024).toFixed(0)} KB`; lab.appendChild(meta); if(t.submitted){const b=document.createElement('span'); b.className='badge'; b.textContent='submitted'; lab.appendChild(b);} row.appendChild(lab); const audio=document.createElement('audio'); audio.controls=true; audio.src=t.url; row.appendChild(audio); els.takes.appendChild(row); }); els.submitBtn.disabled=!takes.some(t=>t.groupKey===GROUP_KEY&&!t.submitted); els.deleteBtn.disabled=!takes.some(t=>t.groupKey===GROUP_KEY); }

    // (Recorder/mic logic omitted here for brevity — stays same as last version, still saving {groupKey: GROUP_KEY} with each take, submitting with IDEMPOTENCY_KEY, etc.)
    // --- You would keep all the MediaRecorder, mic indicator, submit, delete logic from previous full script unchanged, only difference: each take record has groupKey: GROUP_KEY ---

    hydrate();
  </script>
</body>
</html>
